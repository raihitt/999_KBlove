# ZMKコンフィグ変更ロードマップ（低リスク・低影響度順）

## 目的

- 変更影響度が最も小さい項目から順に適用し、安全性を最大限に担保する
- いきなり `keymap` のような広範囲に影響する設定は触らず、独立したパラメータ設定から段階的に改善する
- 毎ステップで確実な `git` 差分確認と実機確認を行い、安全に `tomkey` へ反映する
- AML思想の参考: https://zenn.dev/kot149/articles/zmk-auto-mouse-layer

## 前提

- 起点は `main` ブランチの構成
- `Tomkey` 固有値（`MOUSE` / `SCROLL` / AML切替先レイヤー）は維持する
- 1変更1目的を徹底し、変更単位を小さく保つ

## 運用ルール（影響度・リスク判定基準）

1. **独立した単一パラメータ（最小影響）**: トラックボール速度（CPI）など、他キーレイヤーや主要機能に波及しないもの
2. **AMLのタイミング調整（小影響）**: タイムアウトや遅延など、機能構造は変わらず「閾値」のみ変わるもの
3. **AMLの条件変更（中影響）**: 例外キーの追加や入力継続機能など、特定のユースケースで挙動が変わるもの
4. **Keymapレイアウト変更（大影響）**: 日常の文字入力や全体のレイヤー構造そのものに影響するもの
※ 基本的に上記の「1」から順に適用していく。

---

## フェーズ0: ベースライン固定

1. 作業前の状態を記録する（ドキュメント）
- `docs/aml/01_current_state.md`
- `docs/aml/02_change_points.md`
- `docs/aml/03_rebuild_steps.md`
- `docs/keymap/01_evidence.md`

2. 作業前の状態を記録する（Git履歴）
- `git status`
- `git log --oneline -n 5`

---

## フェーズ1: 独立設定の変更（最小影響）

1. トラックボールの速度（CPI）調整
- 対象: `config/boards/shields/tomkey/tomkey_R.overlay` の `cpi` 設定（例: 400へ変更）
- 期待効果: マウスカーソルの操作感改善
- 確認: マウス速度のみ（他のキー入力・レイヤー遷移に影響がないこと）

---

## フェーズ2: AML パラメータの微調整（小影響）

1. タイムアウト系の微調整
- 例: `zip_temp_layer` の待ち時間調整
- 期待効果: レイヤー遷移の体感改善（早すぎる・遅すぎるタイミング変更）
- 確認: AML遷移の違和感有無と誤動作の減少

2. 誤爆防止設定
- 例: `require-prior-idle-ms` の導入や調整
- 期待効果: 意図しない遷移（タイピング中の誤検知）の削減
- 確認: 通常タイピング時の誤遷移率低下

---

## フェーズ3: AML 挙動の一部変更・除外設定（中影響）

1. AML解除キーの例外設定（Release Key Configuration）
- 例: `tomkey_L.overlay` の `excluded-positions` を用いた、特定キー（クリックやスクロール用キー等）押下時のAML維持設定
- 期待効果: マウス操作用キーを押した際に意図せずAMLが解除されるのを防ぐ
- 確認: 該当キー押下時にAMLが維持されること、他キーでは解除されること

2. 入力継続性改善
- 例: `mkp_input_listener` 関連調整
- 期待効果: クリック、ドラッグ、スクロール継続時の安定化
- 確認: マウスやスクロールの長押し・継続操作の挙動確認

---

## フェーズ4: 各ステップ共通の実機確認フロー（GitHub Actions前提）

※ フェーズ1〜3の各ステップごとに必ず実施する手順
1. 変更: `git add -p`
2. 差分確認: `git diff --staged`
3. 記録＆Push: `git commit -m "feat/aml: <step名>"` として `git push`
   - **※ コミットメッセージには `Before -> After` と `変更確認ポイント` を必ず明記する**
4. 取得＆検証: Actions の完了を待ち `uf2` をダウンロードし、実機で確認

---

## フェーズ5: AML全体整合チェック

1. `overlay` / `conf` 間の矛盾確認
- AML有効条件、レイヤー遷移先、入力系設定の全体的な整合を確認

2. 実機確認を再実施
- タイピング
- AMLへの自動遷移・離脱
- マウスドラッグ、スクロール

3. 修正のフィードバック
- 問題があれば影響度に応じてフェーズ1〜3へ戻し、差分を最小単位で再調整する

---

## フェーズ6: keymap反映（最大影響・最後に実施）

1. `docs/keymap/03_rebuild_steps.md` に沿って適用
- AMLで確定した挙動を前提に、必要最小限だけ `config/tomkey.keymap` を更新する

2. 反映単位を小さく分割
- 対象キー・レイヤーごとに必ず `Before -> After` と **変更確認ポイント** を明記する
- 1変更ごとに `git diff` / コミット＆Push / 実機確認 のサイクルを繰り返す

3. 最終確認
- AML依存設定との矛盾がないこと
- 普段の文字入力にデグレ（回帰）がないこと
