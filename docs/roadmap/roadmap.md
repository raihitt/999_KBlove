# ZMKコンフィグ変更ロードマップ（低リスク・低影響度順）

## 2026-02-25 現在の進捗状況
- [x] フェーズ1: 独立設定（CPI）の調整 (800 CPI)
- [x] フェーズ2: AML パラメータの微調整 (Timeout 100s, IDLE削除)
- [x] フェーズ3: AML 挙動の変更 (Excluded Positions 導入)
- [x] フェーズ6: Keymap 反映 (Quick-tap-ms, Combos)
- **完了**: Conductor思想（即時解除・特定キー維持）に基づく設定が反映済み


## 目的

- 変更影響度が最も小さい項目から順に適用し、安全性を最大限に担保する
- いきなり `keymap` のような広範囲に影響する設定は触らず、独立したパラメータ設定から段階的に改善する
- 毎ステップで確実な `git` 差分確認と実機確認を行い、安全に `tomkey` へ反映する
- AML思想の参考: https://zenn.dev/kot149/articles/zmk-auto-mouse-layer

## 前提

- 起点は `main` ブランチの構成
- `Tomkey` 固有値（`MOUSE` / `SCROLL` / AML切替先レイヤー）は維持する
- 1変更1目的を徹底し、変更単位を小さく保つ

## 運用ルール（影響度・リスク判定基準）

1. **独立した単一パラメータ（最小影響）**: トラックボール速度（CPI）など、他キーレイヤーや主要機能に波及しないもの
2. **AMLのタイミング調整（小影響）**: タイムアウトや遅延など、機能構造は変わらず「閾値」のみ変わるもの
3. **AMLの条件変更（中影響）**: 例外キーの追加や入力継続機能など、特定のユースケースで挙動が変わるもの
4. **Keymapレイアウト変更（大影響）**: 日常の文字入力や全体のレイヤー構造そのものに影響するもの
※ 基本的に上記の「1」から順に適用していく。

---

## フェーズ0: ベースライン固定 [x]

1. 作業前の状態を記録する（ドキュメント） [x]
- `docs/aml/01_current_state.md` [x]
- `docs/aml/02_change_points.md` [x]
- `docs/aml/03_rebuild_steps.md` [x]
- `docs/keymap/01_evidence.md` [x]

2. 作業前の状態を記録する（Git履歴） [x]
- `git status` [x]
- `git log --oneline -n 5` [x]

---

## フェーズ1: 独立設定の変更（最小影響） [x]

1. トラックボールの速度（CPI）調整 [x]
- 対象: `config/boards/shields/tomkey/tomkey_R.overlay` の `cpi` 設定（800 CPI）
- 期待効果: マウスカーソルの操作感改善
- 確認: マウス速度のみ（他のキー入力・レイヤー遷移に影響がないこと） [x]

---

## フェーズ2: AML パラメータの微調整（小影響） [x]

1. タイムアウト系の微調整 [x]
- 例: `zip_temp_layer` の待ち時間調整（100,000ms = 実質永続）
- 期待効果: レイヤー遷移の体感改善（早すぎる・遅すぎるタイミング変更）
- 確認: AML遷移の違和感有無と誤動作の減少 [x]

2. 誤爆防止設定 [x]
- 例: `require-prior-idle-ms` の導入（400msで試行後、フェーズ3のConductor思想により削除）
- 期待効果: 意図しない遷移（タイピング中の誤検知）の削減
- 確認: 通常タイピング時の誤遷移率低下 [x]

---

## フェーズ3: AML 挙動の一部変更・除外設定（中影響） [x]

1. AML解除キーの例外設定（Release Key Configuration） [x]
- 例: `tomkey_L.overlay` の `excluded-positions` を用いた、特定キー（クリックや修飾キー等）押下時のAML維持設定
- 期待効果: マウス操作用キーを押した際に意図せずAMLが解除されるのを防ぐ
- 確認: 該当キー押下時にAMLが維持されること、他キーでは解除されること [x]

2. 入力継続性改善 [x]
- 例: コンボによるマウスボタン・スクロールレイヤーへの導線追加
- 期待効果: クリック、ドラッグ、スクロール継続時の安定化
- 確認: マウスやスクロールの長押し・継続操作の挙動確認 [x]

---

## フェーズ4: 各ステップ共通の実機確認フロー [x]

※ フェーズ1〜3の各ステップごとに実施済み
1. 記録＆Push: `git commit -m "feat/aml: <step名>"` [x]
2. 検証: 実機での挙動確認 [x]

---

## フェーズ5: AML全体整合チェック

1. `overlay` / `conf` 間の矛盾確認
- AML有効条件、レイヤー遷移先、入力系設定の全体的な整合を確認

2. 実機確認を再実施
- タイピング
- AMLへの自動遷移・離脱
- マウスドラッグ、スクロール

3. 修正のフィードバック
- 問題があれば影響度に応じてフェーズ1〜3へ戻し、差分を最小単位で再調整する

---

## フェーズ6: keymap反映（最大影響） [x]

1. `quick-tap-ms` の適用 [x]
- `mt` / `lt` に対して 300ms を設定し、連打時の誤爆を防止

2. マウス操作用コンボの導入 [x]
- `J+K` (MB3), `H+J` (SCROLL) を追加し、ホームポジションからの操作性を向上

3. 最終確認 [x]
- AML依存設定との矛盾がないこと
- 普段の文字入力にデグレ（回帰）がないこと
